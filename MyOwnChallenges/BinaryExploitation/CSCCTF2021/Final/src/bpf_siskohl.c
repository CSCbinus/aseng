#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stddef.h>
#include <sys/mman.h>
#include <sys/prctl.h>
#include <linux/prctl.h>
#include <linux/filter.h>
#include <linux/seccomp.h>
#include "seccomp-bpf.h"
#define ALLOW_SYSCALL(name) \
	BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, __NR_##name, 0, 1), \
	BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW)

#define DISALLOW_SYSCALL(name) \
	BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, __NR_##name, 0, 1), \
	BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_KILL)

#define ALLOW_PROCESS \
    BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW)

const char sc[] = "H\x89\xfcH1\xc0H1\xdbH1\xc9H1\xd2H1\xffH1\xf6H1\xedM1\xc0M1\xc9M1\xd2M1\xdbM1\xe4M1\xedM1\xf6M1\xff";

void seccomping(void){
	struct sock_filter filter[] = {
		VALIDATE_ARCHITECTURE,
		EXAMINE_SYSCALL,
		DISALLOW_SYSCALL(open),
		DISALLOW_SYSCALL(write),
		DISALLOW_SYSCALL(read),
		DISALLOW_SYSCALL(creat),
		DISALLOW_SYSCALL(pwritev),
		DISALLOW_SYSCALL(pwritev2),
		DISALLOW_SYSCALL(pwrite64),
		DISALLOW_SYSCALL(execve),
		DISALLOW_SYSCALL(execveat),
		DISALLOW_SYSCALL(getcpu),
		DISALLOW_SYSCALL(getdents64),
		DISALLOW_SYSCALL(kill),
		DISALLOW_SYSCALL(tkill),
		DISALLOW_SYSCALL(clone),
		DISALLOW_SYSCALL(vfork),
		ALLOW_PROCESS
	};

	struct sock_fprog ban = {
		.len = (unsigned short)(sizeof(filter)/sizeof(filter[0])),
		.filter = filter
	};

	prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0);
	prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &ban);
}


void initial(){
	setvbuf(stdout,NULL,_IONBF,0);
	setvbuf(stdin,NULL,_IONBF,0);
}

void fail(){
	puts("Siskohl doesn't like those bytes!");
	exit(-1);
}


int main(){
	int i=0;
	void (*rwx)();
	unsigned char *scl;
	initial();

	scl = mmap(NULL,0x1000,PROT_READ|PROT_WRITE|PROT_EXEC,MAP_PRIVATE|MAP_ANONYMOUS,-1,0);
	puts(" .----------------.  .----------------.  .----------------.  .----------------.  .----------------.  .----------------.  .----------------. ");
	puts("| .--------------. || .--------------. || .--------------. || .--------------. || .--------------. || .--------------. || .--------------. |");
	puts("| |    _______   | || |     _____    | || |    _______   | || |  ___  ____   | || |     ____     | || |  ____  ____  | || |   _____      | |");
	puts("| |   /  ___  |  | || |    |_   _|   | || |   /  ___  |  | || | |_  ||_  _|  | || |   .'    `.   | || | |_   ||   _| | || |  |_   _|     | |");
	puts("| |  |  (__ \\_|  | || |      | |     | || |  |  (__ \\_|  | || |   | |_/ /    | || |  /  .--.  \\  | || |   | |__| |   | || |    | |       | |");
	puts("| |   '.___`-.   | || |      | |     | || |   '.___`-.   | || |   |  __'.    | || |  | |    | |  | || |   |  __  |   | || |    | |   _   | |");
	puts("| |  |`\\____) |  | || |     _| |_    | || |  |`\\____) |  | || |  _| |  \\ \\_  | || |  \\  `--'  /  | || |  _| |  | |_  | || |   _| |__/ |  | |");
	puts("| |  |_______.'  | || |    |_____|   | || |  |_______.'  | || | |____||____| | || |   `.____.'   | || | |____||____| | || |  |________|  | |");
	puts("| |              | || |              | || |              | || |              | || |              | || |              | || |              | |");
	puts("| '--------------' || '--------------' || '--------------' || '--------------' || '--------------' || '--------------' || '--------------' |");
	puts(" '----------------'  '----------------'  '----------------'  '----------------'  '----------------'  '----------------'  '----------------' ");
	puts("=============================================================================================================================================");
	puts("Welcome to Siskohl Sandbox Machine!");
	puts("The flag is on /home/siskohl/flag.txt! Go get 'em!");

	alarm(30);
	read(0,scl,150);
	//memcpy(scl,sc,48);
	for(i=0;i<149;i++){
		if(scl[i] == '\xcd' && scl[i+1] == '\x80'){
			fail();
		}
		if(scl[i] == '\x0f' && scl[i+1] == '\x05'){
			fail();
		}
	}

	seccomping();
	rwx = (void *)scl;
	rwx();


	return 0;
	
}